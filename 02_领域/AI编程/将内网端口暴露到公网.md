目前的命令行：C:\Tools\ngrok.exe http 3000

  

下面是一份 **从零开始** 配置 ngrok 来“把本地 [http://localhost:3000](http://localhost:3000) 暴露成公网 HTTPS 地址”的超详细步骤——完全针对 **Next.js (或任何本地 3000** **端口****)** 开发环境，确保 Fal 的 Webhook 能顺利访问。整个流程 ≈ 10 分钟搞定。

  

---

  

## 1 准备工作

  

|   |   |
|---|---|
|步骤|说明|
|**① 注册 ngrok 账号**|进入 [ngrok.com](https://ngrok.com)，点击 **Sign up** → 填邮箱 / GitHub／Google 登录即可（免费版就够用）。|
|**② 获取 “Authtoken”**|登录后跳转到 **Dashboard → Your Authtoken**，复制形如 `2J5XabC…` 的一长串字符，待会儿要粘贴到终端里。|
|**③ 安装 ngrok 客户端**|- **Windows**：下载 `.zip` 解压，把 `ngrok.exe` 放到任意文件夹（建议放 `C:\Tools\ngrok`）。<br>- **macOS**：`brew install ngrok/ngrok/ngrok` <br>- **Linux**：`sudo snap install ngrok` 或直接解压官方 `.tar.gz`。|

  

---

  

## 2 在终端里完成一次性配置

  

> 以下示例用 **Windows PowerShell**；macOS/Linux 只需把 `ngrok.exe` 改成 `ngrok`，其余命令一致。

  

```PowerShell
# 1️⃣ 进入 ngrok 所在目录（若已加入 PATH 可跳过）
cd C:\Tools\ngrok

# 2️⃣ 把你的 Authtoken 写入配置（只需执行一次）
.\ngrok.exe config add-authtoken 2J5XabCxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

  

成功后会提示：`Authtoken saved to configuration file: C:\Users\<你>\.config\ngrok\ngrok.yml`

  

---

  

## 3 启动本地开发服务器

  

```Bash
# 进入你的 Next.js 项目根目录
npm run dev         # 或 yarn dev / pnpm dev
# 默认监听 http://localhost:3000
```

  

---

  

## 4 用 ngrok 暴露本地端口

  

在 _另一个_ 终端窗口执行：

  

```PowerShell
C:\Tools\ngrok.exe http 3000
```

  

终端会出现类似输出：

  

```Plain
Session Status                online
Version                       3.9.0
Forwarding                    https://gentle-bass-9e3e9e.ngrok-free.app -> http://localhost:3000
```

  

> **复制第一行** `**https://…ngrok-free.app**`，这就是你的公网 HTTPS 隧道。

  

---

  

## 5 把 Webhook URL 改成 ngrok 地址

  

1. 在 `.env.local` 或代码里新增 / 替换：
    

  

```Plain
NEXT_PUBLIC_FAL_WEBHOOK=https://gentle-bass-9e3e9e.ngrok-free.app/api/fal/webhook
```

  

2. 重启 Next.js 服务器（否则环境变量不会生效）。
    

  

3. **重新触发** Fal 请求
    

  

- 代码里直接读取 `process.env.NEXT_PUBLIC_FAL_WEBHOOK`；
    
- 或拼接时写：
    

  

``ts const webhookUrl = `${process.env.NEXT_PUBLIC_FAL_WEBHOOK}`;``

  

Fal 现在会向 ngrok 隧道发送回调 → ngrok 转发到你本地 `/api/fal/webhook` → 你的逻辑更新 Redis / DB → 前端能正常轮询到 `completed` 状态。

  

---

  

## 6 常见问题 & 解决方案

  

|   |   |   |
|---|---|---|
|问题|现象|处理|
|**Fal Dashboard 仍显示 failed / 无记录**|ngrok 地址填错，或服务没重启|确认 env 变量、端口号、路径都是 **[https://xxx.ngrok-free.app/api/fal/webhook](https://xxx.ngrok-free.app/api/fal/webhook)**|
|**本地终端看到 502 Bad Gateway**|Next.js 没在 3000 端口运行|`npm run dev` 是否在另一个窗口正常输出编译日志？|
|**ngrok 免费版 8 小时断线**|隧道突然失效|重新 `ngrok http 3000`，换新 URL 并同步到 `webhookUrl`|
|**HTTPS Mixed Content 警告**|浏览器加载音频失败|Fal 返回的 `audio_url` 为 HTTPS，前端站点 (ngrok) 也是 HTTPS——不会混合；若用 `localhost` 访问页面，可忽略。|

  

---

  

## 7 下一步：部署到 Vercel 后如何切换

  

1. **项目部署到 Vercel** 后，记下正式域名
    

2. `https://your-app.vercel.app`
    

3. 在生产环境的环境变量里配置
    

  

```Plain
FAL_WEBHOOK=https://your-app.vercel.app/api/fal/webhook
```

3. 本地开发仍用 ngrok，生产自动走 Vercel，二者互不影响。
    

  

---

  

### 小结

  

- **ngrok 安装 + 授权 +** **`ngrok http 3000`** 三步即可拿到公网 HTTPS URL。
    
- 把 **Fal **`**webhookUrl**`** 指向该 URL + **`**/api/fal/webhook**`，就能让 Fal 成功回调。
    
- 开发完成后，把 `webhookUrl` 换成正式域名，ngrok 即可下线。
    

  

按照以上步骤配置完，Fal Dashboard 的 **Webhook status** 应从 _failed_ 变为 *succeeded*，你的前端也会即时拿到生成完毕的状态和 `audio_url`。有其它报错或日志，随时贴出来，再一起排查！